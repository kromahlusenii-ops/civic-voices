// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model User {
  id            String         @id @default(cuid())
  firebaseUid   String?        @unique // Firebase UID for Firebase Auth integration (deprecated - use supabaseUid)
  supabaseUid   String?        @unique // Supabase UID for Supabase Auth integration
  email         String         @unique
  password      String?        // Hashed password for credentials auth (null for OAuth-only users)
  name          String?
  emailVerified DateTime?
  image         String?
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt

  // Onboarding
  onboardingCompletedAt DateTime?  // null means not completed

  // Stripe subscription fields
  stripeCustomerId      String?   @unique
  stripeSubscriptionId  String?   @unique
  subscriptionStatus    String    @default("free") // free, trialing, active, canceled, past_due
  subscriptionPlan      String?   // "pro" when subscribed
  trialStartDate        DateTime?
  trialEndDate          DateTime?
  currentPeriodStart    DateTime?
  currentPeriodEnd      DateTime?

  // Credit fields
  monthlyCredits        Int       @default(0)
  bonusCredits          Int       @default(0)
  creditsResetDate      DateTime?

  // Free tier usage tracking (one-time allowance)
  freeSearchUsed        Boolean   @default(false)
  freeReportUsed        Boolean   @default(false)

  researchJobs  ResearchJob[]
  searches      Search[]
  accounts      Account[]
  sessions      Session[]
  trackedTopics TrackedTopic[]
  creditTransactions CreditTransaction[]
  alerts        Alert[]

  // Organization relationships
  ownedOrganization       Organization?          @relation("OrganizationOwner")
  organizationMemberships OrganizationMember[]

  @@index([firebaseUid])
  @@index([supabaseUid])
  @@index([stripeCustomerId])
  @@map("users")
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@map("accounts")
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("sessions")
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
  @@map("verification_tokens")
}

model ResearchJob {
  id            String         @id @default(cuid())
  userId        String
  user          User           @relation(fields: [userId], references: [id], onDelete: Cascade)

  queryJson     Json           // Search query parameters (keywords, subreddits, filters, etc.)
  status        JobStatus      @default(PENDING)

  // Metadata
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
  startedAt     DateTime?
  completedAt   DateTime?

  // Counts and stats
  totalResults  Int            @default(0)
  topPostCommentsJson Json?

  // Sharing settings
  isPublic              Boolean    @default(false)
  shareToken            String?    @unique
  shareTokenExpiresAt   DateTime?
  shareTokenCreatedAt   DateTime?

  // Email notification tracking
  emailSentAt           DateTime?  // When "report ready" email was sent (prevents duplicates)

  // Relations
  sourceResults SourceResult[]
  insights      Insight[]
  searches      Search[]

  @@index([userId, createdAt(sort: Desc)])
  @@index([status])
  @@index([shareToken])
  @@index([emailSentAt])
  @@map("research_jobs")
}

enum JobStatus {
  PENDING
  RUNNING
  COMPLETED
  FAILED
}

model Search {
  id          String       @id @default(cuid())
  userId      String
  user        User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  queryText   String       // The search query text
  name        String?      // Optional custom name (defaults to queryText in application code)
  sources     Source[]     // Selected sources (X, TikTok, etc.)
  filtersJson Json         // Time filter, location filter, etc.
  totalResults Int         @default(0) // Total number of posts found

  reportId    String?
  report      ResearchJob? @relation(fields: [reportId], references: [id], onDelete: SetNull)

  // Relations
  posts       SearchPost[]

  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt

  @@index([userId, createdAt(sort: Desc)])
  @@index([reportId])
  @@map("searches")
}

model SearchPost {
  id          String   @id @default(cuid())
  searchId    String
  search      Search   @relation(fields: [searchId], references: [id], onDelete: Cascade)

  // Post data (matching Post interface from lib/types/api.ts)
  postId      String   // External platform post ID
  text        String
  author      String
  authorHandle String
  authorAvatar String?
  platform    String   // "x" | "tiktok" | "reddit" | "instagram" | "youtube" | "linkedin"
  url         String
  thumbnail   String?

  // Engagement metrics
  engagement  Json     // { likes, comments, shares, views? }

  // Sentiment classification (from AI analysis)
  sentiment   String?  // "positive" | "negative" | "neutral"

  // Credibility system fields
  credibilityScore  Float?   // 0-1 computed credibility score
  credibilityTier   String?  // "official" | "news" | "journalist" | "expert" | "verified" | "unknown"
  verificationBadge String?  // Badge type if applicable

  // Author metadata for credibility assessment
  authorFollowers   Int?     // Follower count
  authorFollowing   Int?     // Following count
  authorAccountAge  Int?     // Account age in days
  authorVerified    Boolean? // Platform verification status
  authorBio         String?  // Author bio/description

  // Metadata
  createdAt   DateTime // When post was created on external platform
  savedAt     DateTime @default(now()) // When we saved it

  @@index([searchId])
  @@index([searchId, createdAt])
  @@index([credibilityTier])
  @@map("search_posts")
}

model SourceResult {
  id                String       @id @default(cuid())
  jobId             String
  job               ResearchJob  @relation(fields: [jobId], references: [id], onDelete: Cascade)

  source            Source       // reddit, x, tiktok, youtube, linkedin
  externalId        String       // External platform ID (e.g., Reddit post ID)
  url               String       // Full URL to the content

  title             String?      // Optional title (post title, tweet text preview, etc.)
  text              String       // Main text content
  rawJson           Json         // Raw API response for full data preservation

  createdAtExternal DateTime?    // When the content was created on the external platform
  score             Int?         // Upvotes, likes, views, etc. (platform-specific)

  createdAt         DateTime     @default(now())

  @@index([jobId, source])
  @@index([jobId, createdAt])
  @@unique([jobId, source, externalId])
  @@map("source_results")
}

enum Source {
  REDDIT
  X
  TIKTOK
  YOUTUBE
  LINKEDIN
  INSTAGRAM
}

model Insight {
  id          String       @id @default(cuid())
  jobId       String
  job         ResearchJob  @relation(fields: [jobId], references: [id], onDelete: Cascade)

  outputJson  Json         // LLM-generated insights (themes, sentiment, quotes, etc.)
  model       String       // Model used (e.g., "gpt-4", "claude-3-opus")
  tokensUsed  Int?         // Token count if available

  createdAt   DateTime     @default(now())

  @@index([jobId, createdAt(sort: Desc)])
  @@map("insights")
}

model TrackedTopic {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  query     String   // The search query/topic to track
  name      String?  // Optional display name (defaults to query)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([userId, query])
  @@index([userId, createdAt(sort: Desc)])
  @@map("tracked_topics")
}

model CreditTransaction {
  id          String   @id @default(cuid())
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  amount      Int      // positive = add, negative = deduct
  type        String   // "monthly_reset", "overage_purchase", "search_usage", "report_generation"
  description String?
  createdAt   DateTime @default(now())

  @@index([userId])
  @@index([userId, createdAt(sort: Desc)])
  @@map("credit_transactions")
}

// Alert system for email notifications
model Alert {
  id              String   @id @default(cuid())
  userId          String
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  searchQuery     String
  platforms       String[] // ["reddit", "x", "tiktok", "instagram", "youtube"]

  recipients      AlertRecipient[]

  frequency       AlertFrequency @default(DAILY)
  preferredTime   String         @default("09:00") // HH:MM in user's timezone
  timezone        String         @default("America/New_York")
  preferredDay    Int?           // 0 = Sunday, 6 = Saturday (for weekly)

  isActive        Boolean  @default(true)
  lastSentAt      DateTime?
  nextScheduledAt DateTime?

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([userId])
  @@index([isActive, nextScheduledAt])
  @@map("alerts")
}

model AlertRecipient {
  id          String  @id @default(cuid())
  alertId     String
  alert       Alert   @relation(fields: [alertId], references: [id], onDelete: Cascade)

  email       String
  isOwner     Boolean @default(false)
  verified    Boolean @default(false)
  verifyToken String? @unique

  createdAt   DateTime @default(now())

  @@unique([alertId, email])
  @@index([alertId])
  @@map("alert_recipients")
}

enum AlertFrequency {
  INSTANTLY
  HOURLY
  DAILY
  WEEKLY
}

// Organization for team seat management
model Organization {
  id                String               @id @default(cuid())
  name              String
  ownerId           String               @unique
  owner             User                 @relation("OrganizationOwner", fields: [ownerId], references: [id])

  // Seat management
  includedSeats     Int                  @default(1)    // From plan (1, 3, or 5)
  additionalSeats   Int                  @default(0)    // Purchased extra seats
  stripeSeatItemId  String?                             // Stripe subscription item ID for seats

  members           OrganizationMember[]
  invites           OrganizationInvite[]

  createdAt         DateTime             @default(now())
  updatedAt         DateTime             @updatedAt

  @@index([ownerId])
  @@map("organizations")
}

model OrganizationMember {
  id             String       @id @default(cuid())
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  userId         String
  user           User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  role           String       @default("member") // "admin" | "member"
  invitedAt      DateTime     @default(now())
  joinedAt       DateTime?

  @@unique([organizationId, userId])
  @@index([organizationId])
  @@index([userId])
  @@map("organization_members")
}

model OrganizationInvite {
  id             String       @id @default(cuid())
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  email          String
  role           String       @default("member") // "admin" | "member"
  token          String       @unique
  expiresAt      DateTime
  acceptedAt     DateTime?

  createdAt      DateTime     @default(now())

  @@unique([organizationId, email])
  @@index([token])
  @@index([organizationId])
  @@index([expiresAt])
  @@map("organization_invites")
}
